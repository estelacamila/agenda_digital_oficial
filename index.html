<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>ðŸ“… Agenda Digital</title>
<script src="https://unpkg.com/@supabase/supabase-js"></script>
<style>

body {
  background:#f0f2f5;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  display:flex;
  justify-content:center;
  padding:30px 15px;
}

.container {
  background:#fff;
  border-radius:15px;
  padding:25px 30px;
  box-shadow:0 6px 25px rgba(0,0,0,0.1);
  width:100%;
  max-width:500px;
}

h1 {
  text-align:center;
  margin-bottom:25px;
  color:#333;
  font-size:1.8rem;
}

input, button {
  width:100%;
  padding:12px 15px;
  font-size:1rem;
  border-radius:8px;
  border:1px solid #ccc;
  box-sizing:border-box;
}

input:focus { outline:none; border-color:#4CAF50; }

button {
  background-color:#4CAF50;
  color:#fff;
  border:none;
  font-weight:bold;
  cursor:pointer;
  transition:0.3s;
  margin-top:20px;
}

button:hover { background-color:#45a049; }

form {
  display:flex;
  flex-direction:column;
  gap:15px;
  margin-bottom:30px;
}

#quadro-horarios {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:5px;
}

.horario {
  flex:1 0 30%;
  text-align:center;
  padding:10px 12px;
  border-radius:8px;
  cursor:pointer;
  background:#d4f7d4;
  color:#333;
  border:1px solid #4CAF50;
  font-weight:600;
  transition:0.2s;
}

.horario.ocupado { background:#f7d4d4; border-color:#e74c3c; cursor:not-allowed; color:#999; }
.horario.selecionado { background:#4CAF50; color:#fff; }

h2 { margin-bottom:15px; color:#333; font-size:1.5rem; border-bottom:1px solid #ddd; padding-bottom:5px; }

ul { list-style:none; padding:0; margin:0; }

.dia { background:#eafaf1; color:#2e7d32; font-weight:bold; padding:8px 12px; border-radius:8px; margin-top:20px; font-size:1.1rem; }

.horario-item {
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#f9f9f9;
  padding:10px 12px;
  margin-top:8px;
  border-radius:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.05);
  font-size:0.95rem;
  transition:0.2s;
}

.horario-item:hover { background:#f1f1f1; }
.horario-item span { font-weight:600; color:#333; flex-grow:1; }

.btn-action {
  width:36px; height:36px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  display:flex;
  justify-content:center;
  align-items:center;
  font-size:1.1rem;
  transition:0.3s;
  box-shadow:0 2px 6px rgba(0,0,0,0.2);
  margin-left:6px;
}

.btn-excluir {
  background-color:#ff6b6b; color:#fff;
}
.btn-excluir:hover { background-color:#e55353; transform:scale(1.1); box-shadow:0 4px 10px rgba(229,83,83,0.5); }

.btn-editar {
  background-color:#4da6ff; color:#fff;
}
.btn-editar:hover { background-color:#3399ff; transform:scale(1.1); box-shadow:0 4px 10px rgba(51,153,255,0.5); }

.btn-space { width:36px; height:36px; margin-left:6px; }

/* ===================== RESPONSIVIDADE ===================== */
@media(max-width:600px){
  .container { padding:20px; max-width:95%; }
  h1 { font-size:1.6rem; }
  h2 { font-size:1.3rem; }
  input, button { padding:10px 12px; font-size:0.95rem; }
  .horario { flex:1 0 45%; font-size:0.9rem; padding:8px; }
  .horario-item { flex-direction:column; align-items:flex-start; gap:8px; font-size:0.9rem; }
  .horario-item button { align-self:flex-end; width:32px; height:32px; font-size:1rem; margin-left:0; }
}

@media(max-width:400px){
  .horario { flex:1 0 100%; }
  .horario-item { font-size:0.85rem; padding:8px; }
  input, button { font-size:0.9rem; padding:10px; }
  h1 { font-size:1.4rem; }
  h2 { font-size:1.2rem; }
}
</style>

</head>
<body>
<div class="container">
<h1>ðŸ“… Agenda Digital</h1>

<form id="form-agenda">
  <!-- Nome do cliente bloqueado -->
  <input type="text" id="nome" readonly />
  <input type="date" id="data" required />
  <input type="hidden" id="horario" required />
  <div id="quadro-horarios"></div>
  <button type="submit">Agendar</button>
</form>

<h2>Agendamentos</h2>
<ul id="lista"></ul>
</div>

<script>
const SUPABASE_URL = "https://zlifgtznogdejoibzmpu.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsaWZndHpub2dkZWpvaWJ6bXB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNTQyMTgsImV4cCI6MjA3NDkzMDIxOH0.Xn4SvzKEy5SPVuObgWJK6BbAzw5twCtUyrcO4sg9pPM";

const { createClient } = supabase;
const client = createClient(SUPABASE_URL, SUPABASE_KEY);

const form = document.getElementById("form-agenda");
const lista = document.getElementById("lista");
const dataInput = document.getElementById("data");
const horarioInput = document.getElementById("horario");
const quadro = document.getElementById("quadro-horarios");

const tipoUsuario = sessionStorage.getItem("tipoUsuario") || "cliente";
const nomeCliente = sessionStorage.getItem("nomeCliente") || "";

const nomeInput = document.getElementById("nome");
if (tipoUsuario === "cliente") { nomeInput.value = nomeCliente; }
if (tipoUsuario === "admin") { form.style.display = "none"; }

const horariosPadrao = ["09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00"];
let horarioSelecionado = null;

// Atualiza quadro de horÃ¡rios para clientes
async function atualizarQuadro() {
  if (tipoUsuario === "admin") return;
  const dataEscolhida = dataInput.value;
  if (!dataEscolhida){ quadro.innerHTML = ""; return; }

  const { data: agendamentos } = await client
    .from("agendamentos")
    .select("*")
    .gte("horario", dataEscolhida + "T00:00")
    .lt("horario", dataEscolhida + "T23:59");

  quadro.innerHTML = "";
  const ocupados = agendamentos.map(a => new Date(a.horario).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit', hour12:false}));

  horariosPadrao.forEach(h => {
    const div = document.createElement("div");
    div.textContent = h;
    div.classList.add("horario");

    if (ocupados.includes(h)) div.classList.add("ocupado");
    else div.addEventListener("click", () => {
      const prev = quadro.querySelector(".selecionado");
      if(prev) prev.classList.remove("selecionado");
      div.classList.add("selecionado");
      horarioSelecionado = h;

      const [ano, mes, dia] = dataEscolhida.split("-");
      const [hora, min] = h.split(":");
      const dtLocal = new Date(ano, mes-1, dia, hora, min, 0);
      horarioInput.value = dtLocal.toISOString().slice(0,19);
    });

    quadro.appendChild(div);
  });
}

dataInput.addEventListener("change", () => {
  horarioSelecionado = null;
  horarioInput.value = "";
  atualizarQuadro();
});

// SubmissÃ£o do formulÃ¡rio do cliente
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nome = nomeInput.value;
  const dataEscolhida = dataInput.value;
  const horarioEscolhido = horarioSelecionado;

  if (!horarioEscolhido) { alert("Selecione um horÃ¡rio"); return; }

  // Criar objeto Date local
  const [ano, mes, dia] = dataEscolhida.split("-");
  const [hora, min] = horarioEscolhido.split(":");
  const dtLocal = new Date(ano, mes-1, dia, hora, min, 0);

  // Salvar no Supabase
  const { error } = await client.from("agendamentos")
    .insert([{ nome_cliente: nome, horario: dtLocal.toISOString().slice(0,19) }]);

  if (error){ alert("Erro ao agendar: "+error.message); return; }

  alert("Agendamento criado!");

  // WhatsApp com hora correta
  const numeroDona = "5511999999999"; // coloque nÃºmero da dona
  const diaStr = dtLocal.toLocaleDateString('pt-BR');
  const horaStr = dtLocal.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit', hour12:false});
  const mensagem = `OlÃ¡! Sou ${nome} e acabei de agendar meu horÃ¡rio no site para o dia ${diaStr} Ã s ${horaStr}.`;
  const linkWhats = `https://wa.me/${numeroDona}?text=${encodeURIComponent(mensagem)}`;
  window.open(linkWhats, "_blank");

  form.reset();
  horarioSelecionado = null;
  horarioInput.value = "";
  quadro.innerHTML = "";
  carregarAgendamentos();
});

// Carregar agendamentos
async function carregarAgendamentos(){
  const { data } = await client.from("agendamentos").select("*").order("horario",{ascending:true});
  lista.innerHTML = "";
  if(data){
    let lastDia = "";
    data.forEach(item => {
      if(tipoUsuario==="cliente" && item.nome_cliente.toLowerCase()!==nomeCliente.toLowerCase()) return;

      const dt = new Date(item.horario);
      const diaStr = dt.toLocaleDateString('pt-BR');
      const horaStr = dt.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit', hour12:false});

      if(diaStr!==lastDia){
        const diaLi = document.createElement("li");
        diaLi.textContent = diaStr;
        diaLi.classList.add("dia");
        lista.appendChild(diaLi);
        lastDia = diaStr;
      }

      const li = document.createElement("li");
      li.classList.add("horario-item");
      li.innerHTML = `<span>${item.nome_cliente}</span> - ${horaStr} - [${item.status || 'pendente'}]`;

      if(tipoUsuario==="cliente"){
        const btn = document.createElement("button");
        btn.classList.add("btn-action","btn-excluir");
        btn.title = "Excluir";
        btn.innerHTML = "ðŸ—‘ï¸";
        btn.addEventListener("click", async () => {
          if(confirm("Deseja apagar?")){
            await client.from("agendamentos").delete().eq("id", item.id);
            carregarAgendamentos();
            atualizarQuadro();
          }
        });
        li.appendChild(btn);
      } else if(tipoUsuario==="admin"){
        const btnExcluir = document.createElement("button");
        btnExcluir.classList.add("btn-action","btn-excluir");
        btnExcluir.title = "Excluir";
        btnExcluir.innerHTML = "ðŸ—‘ï¸";
        btnExcluir.addEventListener("click", async () => {
          if(confirm("Deseja apagar?")){
            await client.from("agendamentos").delete().eq("id", item.id);
            carregarAgendamentos();
          }
        });

        const btnEditar = document.createElement("button");
        btnEditar.classList.add("btn-action","btn-editar");
        btnEditar.title = "Editar";
        btnEditar.innerHTML = "âœï¸";
        btnEditar.addEventListener("click", async () => {
          const diaStr = item.horario.split("T")[0];
          const { data: agendamentosDia } = await client.from("agendamentos").select("*")
            .gte("horario", diaStr+"T00:00")
            .lt("horario", diaStr+"T23:59");

          const ocupados = agendamentosDia.map(a=>({hora:new Date(a.horario).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit', hour12:false}), id: a.id}));

          let novoHorario = null;
          while(!novoHorario){
            const horaEscolhida = prompt(`Digite novo horÃ¡rio (${horariosPadrao.join(", ")})`);
            if(!horaEscolhida) break;
            if(!horariosPadrao.includes(horaEscolhida)){ alert("HorÃ¡rio invÃ¡lido!"); continue; }
            if(ocupados.some(o=>o.hora===horaEscolhida && o.id!==item.id)){ alert("HorÃ¡rio jÃ¡ ocupado!"); continue; }
            novoHorario = horaEscolhida;
          }

          if(novoHorario){
            const [ano, mes, dia] = diaStr.split("-");
            const [hora, min] = novoHorario.split(":");
            const dtLocal = new Date(ano, mes-1, dia, hora, min, 0);
            await client.from("agendamentos").update({ horario: dtLocal.toISOString().slice(0,19) }).eq("id", item.id);
            carregarAgendamentos();
          }
        });

        li.appendChild(btnExcluir);
        li.appendChild(btnEditar);
      }

      lista.appendChild(li);
    });
  }
}

carregarAgendamentos();
atualizarQuadro();

</script>
</body>
</html>
